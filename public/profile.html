<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - EpicGame</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="profile-page">
    <header class="main-header">
        <div class="container">
            <h1 class="logo">EpicGame</h1>
            <nav>
                <ul>
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/me">Chat</a></li>
                    <li><a href="/profile" class="active">Mon Profil</a></li>
                    <li><a href="/logout">D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="profile-preview">
                <div class="banner-container">
                    <div class="banner-overlay">
                        <label for="banner" class="edit-banner-btn">Changer la banni√®re</label>
                        <input type="file" id="banner" name="banner" accept="image/*" style="display: none;">

                    </div>
                    <div class="avatar-container">
                        <img id="profile-pic-preview" class="profile-avatar" alt="Photo de profil">
                        <label for="profile_pic" class="edit-avatar-btn">üì∑</label>
                        <input type="file" id="profile_pic" name="profile_pic" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="profile-info">
                    <h2 id="username-display"></h2>
                    <div class="bio-section">
                        <textarea id="bio" name="bio" rows="4" placeholder="√âcrivez quelque chose sur vous..."></textarea>
                    </div>
                    <button type="button" id="save-btn">Sauvegarder les modifications</button>
                </div>
            </div>
        </div>
    </main>
    <script>
        let bannerPosX = 50;
        let bannerPosY = 50;
        let bannerZoom = 1;
        let bannerRotate = 0;

        let avatarZoom = 1;
        let avatarPosX = 50;
        let avatarPosY = 50;

        // Charger les donn√©es du profil
        fetch('/api/profile')
            .then(response => response.json())
            .then(data => {
                document.getElementById('username-display').textContent = data.username;
                bannerZoom = data.banner_zoom || 1;
                bannerPosX = data.banner_pos_x || 50;
                bannerPosY = data.banner_pos_y || 50;
                bannerRotate = data.banner_rotate || 0;
                if (data.banner) {
                    document.querySelector('.banner-container').style.backgroundImage = `url('/uploads/${data.banner}')`;
                    document.querySelector('.banner-container').style.backgroundSize = '100% auto';
                    document.querySelector('.banner-container').style.backgroundPosition = 'center';
                    document.querySelector('.banner-container').style.backgroundRepeat = 'no-repeat';
                } else {
                    document.querySelector('.banner-container').style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    document.querySelector('.position-controls').style.display = 'none';
                }
                if (data.profile_pic) {
                    document.getElementById('profile-pic-preview').src = '/uploads/' + data.profile_pic;
                    document.getElementById('profile-pic-preview').style.display = 'block';
                } else {
                    // Avatar par d√©faut : premi√®re lettre
                    const avatar = document.getElementById('profile-pic-preview');
                    avatar.style.display = 'flex';
                    avatar.style.backgroundColor = '#5865f2';
                    avatar.style.color = 'white';
                    avatar.style.fontSize = '40px';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.textContent = data.username[0].toUpperCase();
                    avatar.src = ''; // pas d'image
                }
                document.getElementById('bio').value = data.bio || '';
            })
            .catch(error => console.error('Erreur:', error));

        // Modal pour positionner la banni√®re
        const positionModal = document.createElement('div');
        positionModal.id = 'position-modal';
        positionModal.style.position = 'fixed';
        positionModal.style.top = '0';
        positionModal.style.left = '0';
        positionModal.style.width = '100%';
        positionModal.style.height = '100%';
        positionModal.style.background = 'rgba(0,0,0,0.8)';
        positionModal.style.display = 'none';
        positionModal.style.alignItems = 'center';
        positionModal.style.justifyContent = 'center';
        positionModal.style.zIndex = '2000';
        positionModal.innerHTML = `
            <div style="background: #36393f; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; max-width: 900px; color: #dcddde;">
                <h3 style="margin-bottom: 10px; color: #ffffff;">Positionnez votre banni√®re</h3>
                <p style="margin-bottom: 20px; color: #b9bbbe; font-size: 14px;">Cliquez et glissez sur l'image pour la d√©placer. Utilisez la molette de la souris pour zoomer.</p>
                <div id="modal-banner" style="width: 600px; height: 150px; margin: 20px auto; background: center; background-size: auto; background-repeat: no-repeat; border: 2px solid #202225; border-radius: 8px; cursor: move; position: relative; overflow: hidden;">
                    <div id="visible-area" style="position: absolute; top: 25px; left: 100px; width: 400px; height: 100px; border: 2px solid #ffffff; pointer-events: none; box-sizing: border-box; background: rgba(0,0,0,0.3);"></div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <span style="color: #b9bbbe; font-size: 14px;">Zoom image:</span>
                    <input type="range" id="zoom-slider" min="0.5" max="1" step="0.1" value="1" style="flex: 1; max-width: 200px;">
                    <button id="modal-rotate" style="padding: 8px 16px; background: #5865f2; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Rotate</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="apply-position" style="padding: 10px 20px; background: #43b581; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Appliquer</button>
                    <button id="cancel-position" style="padding: 10px 20px; background: #f04747; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Annuler</button>
                </div>
            </div>
        `;
        document.body.appendChild(positionModal);

        // Modal pour positionner l'avatar
        const avatarPositionModal = document.createElement('div');
        avatarPositionModal.id = 'avatar-position-modal';
        avatarPositionModal.style.position = 'fixed';
        avatarPositionModal.style.top = '0';
        avatarPositionModal.style.left = '0';
        avatarPositionModal.style.width = '100%';
        avatarPositionModal.style.height = '100%';
        avatarPositionModal.style.background = 'rgba(0,0,0,0.8)';
        avatarPositionModal.style.display = 'none';
        avatarPositionModal.style.alignItems = 'center';
        avatarPositionModal.style.justifyContent = 'center';
        avatarPositionModal.style.zIndex = '2000';
        avatarPositionModal.innerHTML = `
            <div style="background: #36393f; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; max-width: 400px; color: #dcddde;">
                <h3 style="margin-bottom: 10px; color: #ffffff;">Positionnez votre avatar</h3>
                <p style="margin-bottom: 20px; color: #b9bbbe; font-size: 14px;">Cliquez et glissez sur l'image pour la d√©placer. Utilisez la molette de la souris pour zoomer.</p>
                <div id="modal-avatar" style="width: 200px; height: 200px; margin: 20px auto; background: center; background-size: auto; background-repeat: no-repeat; border: 2px solid #202225; border-radius: 50%; cursor: move; position: relative; overflow: hidden;">
                    <div id="avatar-visible-area" style="position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid #ffffff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; background: rgba(0,0,0,0.3);"></div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <span style="color: #b9bbbe; font-size: 14px;">Zoom image:</span>
                    <input type="range" id="avatar-zoom-slider" min="0.5" max="3" step="0.1" value="1" style="flex: 1; max-width: 200px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="avatar-apply-position" style="padding: 10px 20px; background: #43b581; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Appliquer</button>
                    <button id="avatar-cancel-position" style="padding: 10px 20px; background: #f04747; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Annuler</button>
                </div>
            </div>
        `;
        document.body.appendChild(avatarPositionModal);

        let modalZoom = 1;
        let modalPosX = 50;
        let modalPosY = 50;
        let modalRotate = 0;
        let w = 600 / modalZoom;
        let h = w * 0.25;
        let minLeft, maxLeft, minTop, maxTop;

        let avatarModalZoom = 1;
        let avatarModalPosX = 50;
        let avatarModalPosY = 50;

        function updateLimits() {
            minLeft = Math.max(0, (600 - w) / 2);
            maxLeft = Math.min(200, (600 - w) / 2 + w - 400);
            minTop = Math.max(0, (150 - h) / 2);
            maxTop = Math.min(50, (150 - h) / 2 + h - 100);
        }



        // Pr√©visualisation des images
        document.getElementById('banner').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalZoom = 0.5;
                    modalPosX = 50;
                    modalPosY = 50;
                    modalRotate = 0;
                    w = 600 / modalZoom;
                    h = w * 0.25;
                    updateLimits();
                    document.getElementById('modal-banner').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('modal-banner').style.backgroundSize = `${100 / modalZoom}% auto`;
                    document.getElementById('modal-banner').style.backgroundPosition = 'center';
                    document.getElementById('modal-banner').style.transform = `rotate(${modalRotate}deg)`;
                    document.getElementById('zoom-slider').value = modalZoom;
                    positionModal.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('zoom-slider').addEventListener('input', (e) => {
            modalZoom = parseFloat(e.target.value);
            w = 600 / modalZoom;
            h = w * 0.25;
            updateLimits();
            document.getElementById('modal-banner').style.backgroundSize = `${100 / modalZoom}% auto`;
            // V√©rifier si la position actuelle couvre visible-area, sinon recentrer
            const leftX = (modalPosX / 100) * (600 - w);
            const rightX = leftX + w;
            const leftY = (modalPosY / 100) * (150 - h);
            const rightY = leftY + h;
            if (!(leftX <= 100 && rightX >= 500 && leftY <= 25 && rightY >= 125)) {
                modalPosX = 50;
                modalPosY = 50;
                document.getElementById('modal-banner').style.backgroundPosition = 'center';
            }
        });

        document.getElementById('modal-rotate').addEventListener('click', () => {
            modalRotate = (modalRotate + 90) % 360;
            document.getElementById('modal-banner').style.transform = `rotate(${modalRotate}deg)`;
        });
        document.getElementById('apply-position').addEventListener('click', () => {
            bannerZoom = modalZoom;
            bannerPosX = modalPosX;
            bannerPosY = modalPosY;
            bannerRotate = modalRotate;
            document.querySelector('.banner-container').style.backgroundImage = document.getElementById('modal-banner').style.backgroundImage;
            document.querySelector('.banner-container').style.transform = `rotate(${bannerRotate}deg)`;
            document.querySelector('.banner-container').style.backgroundPosition = `${bannerPosX}% ${bannerPosY}%`;
            document.querySelector('.banner-container').style.backgroundSize = `${100 / bannerZoom}% auto`;
            // Sauvegarder les param√®tres
            const paramsFormData = new FormData();
            paramsFormData.append('bannerZoom', bannerZoom);
            paramsFormData.append('bannerPosX', bannerPosX);
            paramsFormData.append('bannerPosY', bannerPosY);
            paramsFormData.append('bannerRotate', bannerRotate);
            fetch('/profile', {
                method: 'POST',
                body: paramsFormData
            }).then(response => {
                if (response.ok) {
                    console.log('Param√®tres sauvegard√©s');
                }
            });
            positionModal.style.display = 'none';
        });
        document.getElementById('cancel-position').addEventListener('click', () => {
            positionModal.style.display = 'none';
        });

        // Drag and drop pour d√©placer l'image
        let isDragging = false;
        let startX, startY;

        document.getElementById('modal-banner').addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                const newModalPosX = modalPosX - deltaX / 2;
                const newModalPosY = modalPosY - deltaY / 2;
                const leftX = (newModalPosX / 100) * (600 - w);
                const rightX = leftX + w;
                const leftY = (newModalPosY / 100) * (150 - h);
                const rightY = leftY + h;
                if (leftX <= 100 && rightX >= 500 && leftY <= 25 && rightY >= 125) {
                    modalPosX = newModalPosX;
                    modalPosY = newModalPosY;
                    document.getElementById('modal-banner').style.backgroundPosition = `${modalPosX}% ${modalPosY}%`;
                }
                startX = e.clientX;
                startY = e.clientY;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });



        // Zoom avec la molette
        document.getElementById('modal-banner').addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) {
                modalZoom = Math.min(1, modalZoom * 1.1);
            } else {
                modalZoom = Math.max(0.5, modalZoom / 1.1);
            }
            w = 600 / modalZoom;
            h = w * 0.5;
            document.getElementById('modal-banner').style.backgroundSize = `${100 / modalZoom}% auto`;
            document.getElementById('zoom-slider').value = modalZoom;
            updateLimits();
            // V√©rifier si la position actuelle couvre visible-area, sinon recentrer
            const leftX = (modalPosX / 100) * (600 - w);
            const rightX = leftX + w;
            const leftY = (modalPosY / 100) * (150 - h);
            const rightY = leftY + h;
            if (!(leftX <= 100 && rightX >= 500 && leftY <= 25 && rightY >= 125)) {
                modalPosX = 50;
                modalPosY = 50;
                document.getElementById('modal-banner').style.backgroundPosition = 'center';
            }
        });

        document.getElementById('profile_pic').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    avatarZoom = 1;
                    avatarPosX = 50;
                    avatarPosY = 50;
                    document.getElementById('modal-avatar').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('modal-avatar').style.backgroundSize = `${100 / avatarZoom}% auto`;
                    document.getElementById('modal-avatar').style.backgroundPosition = 'center';
                    document.getElementById('avatar-zoom-slider').value = avatarZoom;
                    avatarPositionModal.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        });

        // Event listeners pour la modal avatar
        document.getElementById('avatar-zoom-slider').addEventListener('input', (e) => {
            avatarModalZoom = parseFloat(e.target.value);
            document.getElementById('modal-avatar').style.backgroundSize = `${100 / avatarModalZoom}% auto`;
        });

        let avatarIsDragging = false;
        let avatarStartX, avatarStartY;

        document.getElementById('modal-avatar').addEventListener('mousedown', (e) => {
            avatarIsDragging = true;
            avatarStartX = e.clientX;
            avatarStartY = e.clientY;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (avatarIsDragging) {
                const deltaX = e.clientX - avatarStartX;
                const deltaY = e.clientY - avatarStartY;
                avatarModalPosX += deltaX / 2;
                avatarModalPosY += deltaY / 2;
                document.getElementById('modal-avatar').style.backgroundPosition = `${avatarModalPosX}% ${avatarModalPosY}%`;
                avatarStartX = e.clientX;
                avatarStartY = e.clientY;
            }
        });

        document.addEventListener('mouseup', () => {
            avatarIsDragging = false;
        });

        document.getElementById('modal-avatar').addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) {
                avatarModalZoom = Math.min(3, avatarModalZoom * 1.1);
            } else {
                avatarModalZoom = Math.max(0.5, avatarModalZoom / 1.1);
            }
            document.getElementById('modal-avatar').style.backgroundSize = `${100 / avatarModalZoom}% auto`;
            document.getElementById('avatar-zoom-slider').value = avatarModalZoom;
        });

        document.getElementById('avatar-apply-position').addEventListener('click', () => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                const scale = avatarModalZoom;
                const posX = avatarModalPosX;
                const posY = avatarModalPosY;
                const imgWidth = img.width / scale;
                const imgHeight = img.height / scale;
                const offsetX = (posX / 100) * (200 - imgWidth);
                const offsetY = (posY / 100) * (200 - imgHeight);
                ctx.drawImage(img, -offsetX, -offsetY, img.width / scale, img.height / scale);
                canvas.toBlob((blob) => {
                    const croppedFile = new File([blob], 'avatar.jpg', {type: 'image/jpeg'});
                    const avatar = document.getElementById('profile-pic-preview');
                    avatar.src = canvas.toDataURL();
                    avatar.style.display = 'block';
                    avatar.style.backgroundColor = '';
                    avatar.style.color = '';
                    avatar.style.fontSize = '';
                    avatar.textContent = '';
                    window.croppedAvatarFile = croppedFile;
                    avatarPositionModal.style.display = 'none';
                });
            };
            const bgImage = document.getElementById('modal-avatar').style.backgroundImage;
            img.src = bgImage.slice(5, -2);
        });

        document.getElementById('avatar-cancel-position').addEventListener('click', () => {
            avatarPositionModal.style.display = 'none';
        });

        // Sauvegarder
        document.getElementById('save-btn').addEventListener('click', function() {
            const formData = new FormData();
            const bannerInput = document.getElementById('banner');
            const profilePicInput = document.getElementById('profile_pic');
            const bio = document.getElementById('bio').value;
            // Ajouter les param√®tres de position
            formData.append('bannerZoom', bannerZoom);
            formData.append('bannerPosX', bannerPosX);
            formData.append('bannerPosY', bannerPosY);
            formData.append('bannerRotate', bannerRotate);

            if (bannerInput.files[0]) {
                formData.append('banner', bannerInput.files[0]);
            }
            if (window.croppedAvatarFile) {
                formData.append('profile_pic', window.croppedAvatarFile);
            } else if (profilePicInput.files[0]) {
                formData.append('profile_pic', profilePicInput.files[0]);
            }
            formData.append('bio', bio);

            fetch('/profile', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert('Profil sauvegard√© !');
                    // Recharger la page pour mettre √† jour
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('Erreur lors de la sauvegarde: ' + error.message);
                console.error('Erreur:', error);
            });
        });




    </script>
</body>
</html>